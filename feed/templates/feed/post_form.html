{% load wagtailimages_tags %}

<form method="post" enctype="multipart/form-data"
      hx-post="{% if post %}{% url 'feed:post_update' post.pk %}{% else %}{% url 'feed:post_create' %}{% endif %}"
      hx-target="#posts-container"
      hx-swap="innerHTML"
      hx-on-htmx-after-request="
          if(event.detail.successful) {
              document.getElementById('post-modal').classList.add('hidden');
          }
      ">
    {% csrf_token %}
    <div class="space-y-6">
        <div>
            <label class="block font-medium mb-2">–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞</label>
            {{ form.content }}
        </div>

        {% comment %}
        <div>
            <label class="block font-medium mb-2">–í–∏–¥–∏–º–æ—Å—Ç—å (–≥—Ä—É–ø–ø—ã)</label>
            {{ form.visibility_groups }}
        </div>
        {% endcomment %}

        {% if form.pinned %}
            <div class="flex items-center">
                {{ form.pinned }}
                <label class="ml-2">–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π –ø–æ—Å—Ç</label>
            </div>
        {% endif %}

        <!-- –¢–µ–∫—É—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏) -->
        {% if post and post.images.exists %}
            <div>
                <p class="font-medium mb-3">–¢–µ–∫—É—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</p>
                <div class="grid grid-cols-3 gap-4">
                    {% for img_link in post.images.all %}
                        <div class="relative group">
                            {% image img_link.image fill-200x200 as ph %}
                            <img src="{{ ph.url }}" class="rounded-lg">
                            <button hx-post="{% url 'feed:image_delete' img_link.pk %}"
                                    hx-target="closest div" hx-swap="outerHTML"
                                    hx-confirm="–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?"
                                    class="absolute top-2 right-2 bg-red-600 text-white rounded-full w-8 h-8 opacity-0 group-hover:opacity-100 transition">
                                √ó
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- –ù–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
        <div>
            <label class="block font-medium mb-2">–î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
            <input type="file" name="images" multiple accept="image/*" class="w-full border rounded-lg p-2">
        </div>

        <!-- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
        {% if post and post.documents.exists %}
            <div>
                <p class="font-medium mb-3">–¢–µ–∫—É—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:</p>
                <ul class="space-y-2">
                    {% for doc_link in post.documents.all %}
                        <li class="flex justify-between items-center">
                            <a href="{{ doc_link.document.url }}" target="_blank" class="text-cyan-600 hover:underline">
                                üìÑ {{ doc_link.document.title }}
                            </a>
                            <button hx-post="{% url 'feed:document_delete' doc_link.pk %}"
                                    hx-target="closest li" hx-swap="outerHTML"
                                    hx-confirm="–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?"
                                    class="text-red-600 text-sm">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <div>
            <label class="block font-medium mb-2">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã</label>
            <input type="file" name="documents" multiple class="w-full border rounded-lg p-2">
        </div>

        <div class="flex justify-end space-x-4 pt-6">
            <button type="submit" class="bg-cyan-700 text-white px-8 py-3 rounded-lg hover:bg-cyan-600">
                {{ title|default:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" }}
            </button>
            <button type="button"
                hx-on-click="this.closest('#post-modal').classList.add('hidden')"
                class="text-gray-600 px-6 py-3">
                –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
</form>